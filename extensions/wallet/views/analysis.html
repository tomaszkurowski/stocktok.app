<div class="page about active">
    
    <div class="page-views analysis-page-views">
        
        <div class="page-view" data-view="dynamic-wallet-trend">
            <div class="page-title">
                <h2>Dynamic Trend</h2>                 
                <div class="tooltip-preview dynamic-wallet-trend">
                    <div class="total"></div>
                    <div class="date"></div>
                </div>
            </div>            
            <div class="widget dynamic-wallet-trend" id="dynamic-wallet-trend"></div>
            
        </div>
        <div class="page-view" data-view="wallet-strength">
            
            <div class="page-title">
                <h2>Strength</h2>                 
                <div class="tooltip-preview wallet-strength">
                    <div class="total"></div>
                    <div class="date"></div>
                </div>                
            </div>                                          
            <div class="widget wallet-strength" id="wallet-strength"></div>
            
        </div>
        <div class="page-view" data-view="wallet-structure">
            
            <div class="page-title">
                <h2>Structure</h2>  
                <div class="tooltip-preview wallet-structure">
                    <div class="total"></div>
                    <div class="date"></div>
                </div>
            </div>                            
            <div class="widget wallet-structure" id="wallet-structure"></div>
            
        </div>
    </div>
    
</div>

<script type="text/javascript">

    $(document).ready(function(){
        switcher({ key: 'swipeable', class: 'icon-swipe',  value: settings.swipeable ? settings.swipeable : 'false'},function(){ swipeable(); }); // => ui.js   
    });


    $('.page-views').not('.slick-initialized').slick({
        arrows:false,
        dots:false,
        infinite: true,
        initialSlide:2
    }).on('beforeChange', (event, slick, currentSlide, nextSlide) => {
        if (currentSlide !== nextSlide) { $('.changer-page-views .changer').removeClass('active'); $('.changer[data-slick-position='+(nextSlide+1)+']').addClass('active'); }     
    }); 
 

    var makeSumSeries = function (chart) {
        var series = chart.series,
            each = Highcharts.each,
            sum,
            x=[],
            flag;
        series[series.length - 1].update({
            data: []
        }, false);
        
        console.log(series);
        each(series, function(p,z){
            console.log(p.visible);
            if(p.visible===true){
            each(p.xData, function(serie,i){
               
                flag=true;
                for(var b=0;b<x.length;b++){
                    if(serie===x[b]){
                        flag=false;
                   }
               }
               if(flag){
                    x.push(serie);
               }
           });
            }
        });
        
        console.log(x);
        for (var i = 0; i < x.length; i++) {
            sum = 0;
            each(series, function (p, k) {
                if (p.name!=='Total' && p.visible === true) {
                    each(p.xData, function (ob, j) {
                        if (ob === x[i]) {
                            sum += p.yData[j];
                        }
                    });
                }
            });
            series[series.length - 1].addPoint({
                y: parseFloat(sum.toFixed(2)),
                x:  x[i]
            }, false);
        }
        chart.redraw();
    };

    function add_series(graph,series,title){

        graph.addSeries({
            data: series,
            //type: 'ohlc',
            name: title,
            tooltip: {
                valueDecimals: 2,
                pointFormat: '{point.y}'
            }
        });     
    }
    
    function dynamic_wallet_trend(){
        
        if (config.debug) console.log('Dynamic Wallet Trend');
        $.ajax({
            url: config.api_url,
            data: { endpoint: '/wallet/trend' },
            type: 'GET',
            dataType: 'JSON',
            cache: false,
            
            success: function(response){
                if (config.debug) console.log(response);                
                
        
        
                // Wallet Strength
                var totals  = [];
                var margins = [];
                var symbols = [];                
                $.each(response.series,function(index,serie){
                    symbols.push(index);
                    totals.push(serie.total[serie.total.length - 1][1]);
                    margins.push(serie.margin[serie.margin.length - 1][1]);
                });
                wallet_strength(symbols,totals,margins);
                wallet_structure(symbols,totals,margins);
                

                
                var stock_chart = Highcharts.stockChart('dynamic-wallet-trend', {
                    global: {
                        useUTC: false
                    },
                    title: false,
                    scrollbar: { enabled: false },
                    navigator: { enabled: false },
                    xAxis: {
                        crosshair: true,
                        snap:false,
                        opposite: true
                    },
                    yAxis: {
                        crosshair: true,
                        snap:false
                    },
                    tooltip: {
                        positioner: function () {
                            if ($('body').hasClass('stock-price-pro-mode')) return { x: 50, y: 0 }
                            else return { x: 10, y: 0 };                                                        
                        },
                        pointFormatter:function(){
                            
                            console.log(this);
                            $('.tooltip-preview.dynamic-wallet-trend .total').text(format_price(this.y,2)+ ' '+ settings.display_currency);
                            $('.tooltip-preview.dynamic-wallet-trend .date').text(this.series.name + ', '+format_date(this.x));
                            
                            return '';
                        },
                        split: false,
                        followTouchMove: true,
                        followPointer:false
                    },
                    stockTools:{
                      gui: { enabled: false }  
                    },
                    chart:{
                        spacing:[15,15,15,15],
                        type: 'line'
                    }, 
                    plotOptions: {
                        series: {
                            lineWidth: 1,
                            states: {
                                hover: { enabled: true }
                            },
                            events: {
                                hide: function () {
                                    makeSumSeries(this.chart);
                                },
                                show: function () {
                                    makeSumSeries(this.chart);
                                }
                            }
                        }                                               
                    },
                    legend: { enabled: true }
                    //annotations: [{
                    //    labels: [{
                    //        point: {
                    //            xAxis: 0,
                    //            yAxis: 0,
                    //            x: '865839600000',
                    //            y: 250,
                    //            text: 'Purchase'
                    //        }
                    //    }]
                    //}]                    
                });
                
                $.each(response.series,function(index,serie){
                    if (settings.analysis_scope==='total') add_series(stock_chart,serie.total,index);
                    else add_series(stock_chart,serie.margin,index);                    
                });
                var label='Margin';                
                if (settings.analysis_scope==='total') label='Total';
                
                $('.changer.analysis-scope .selected').text(label);
                
                stock_chart.addSeries({
                    data: [],
                    name: label
                });
                makeSumSeries(stock_chart);

            },
            error: function(response){
                console.log(response);
            }
        });
        
    }
    function wallet_strength(symbols,totals,margins){
               
        var options = {
            series: [{
                name: 'Total',
                data: totals
            }, {
                name: 'Margin',
                data: margins
            }],
            chart: {
                type: 'bar',
                height: $('.widget.wallet-strength').height(),
                toolbar: { show:false },
                offsetY: 0
            },
            dataLabels: {
                enabled:false
            },
            plotOptions: {
                bar: {
                    horizontal: true,
                    barHeight:'30px',
                    borderRadius:0
                },
            },
            grid:{
                padding: { bottom:10 },
                borderColor: settings.design.color_bg
            },            
            xaxis: {
                categories: symbols,
                axisBorder:{ color: settings.design.color_bg }
            },
            tooltip: {
                custom: function ({series, seriesIndex, dataPointIndex, w}) {
                    //console.log(series[seriesIndex][dataPointIndex]);
                    //console.log(w.globals.labels[dataPointIndex]);
                    //console.log(w.globals.seriesNames[seriesIndex]);                    
                    $('.tooltip-preview.wallet-strength .total').text(format_price(series[seriesIndex][dataPointIndex],2)+ ' '+ settings.display_currency);
                    $('.tooltip-preview.wallet-strength .date').html(w.globals.seriesNames[seriesIndex] + ': <b>'+w.globals.labels[dataPointIndex]+'</b>');                        

                    return;
                }
            },
            fill: {
                opacity: 1
            },
          };

        $("#wallet-strength").html('');
        var chart = new ApexCharts(document.querySelector("#wallet-strength"), options);
        chart.render();
        
    }
   
    function wallet_structure(symbols,totals,margins){
                
        
        var series = margins;       
        if (settings.analysis_scope==='total'){
            series = totals;
        }
        
        var grand_total = 0;
        $.each(series,function(index,serie){
            grand_total += serie; 
        });
        
        var options = {
            series: series,
            labels: symbols,

            chart: {                                
                type: 'donut',                                                                
                fill: {
                    type: 'gradient'
                },
                height:420
            },
            legend: {
                position:'bottom',
                fontSize: '14px',
                fontFamily: 'gotham-regular',
                itemMargin: {
                    horizontal: 10,
                    vertical: 5
                }                                        
            },
            plotOptions: {
                pie: {
                  donut:{
                      size:'95%',
                      labels: { 
                          show:true,
                          value:{
                            formatter: function(value, opts){
                                return parseFloat(value).toFixed(2)+ '%';                                
                            }
                          },
                          total: {
                            show: true,
                            label: 'All',
                            color: '#7ebd0b',
                            formatter: function (chart) {
                                return '100.00%';
                            }

                          }
                      }
                  }
                }
            },
            stroke:{ colors: [settings.design.color_bg2], width:1 }
        };
        
        $("#wallet-structure").html('');
        var chart2 = new ApexCharts(document.querySelector("#wallet-structure"), options);
        chart2.render();
        
    }
    
    
    
    dynamic_wallet_trend();

</script>